import { NextResponse } from 'next/server'
import { requireAdminApi } from '@/src/lib/auth'
import { deleteCase, getCaseById, updateCase } from '@/src/lib/db'

export const runtime = 'nodejs'

type Ctx = { params: { id: string } }

export async function GET(req: Request, ctx: Ctx) {
  if (!requireAdminApi(req)) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  const c = await getCaseById(ctx.params.id)
  if (!c) return NextResponse.json({ error: 'Not found' }, { status: 404 })
  return NextResponse.json({ ok: true, case: c })
}

export async function PUT(req: Request, ctx: Ctx) {
  if (!requireAdminApi(req)) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  const body = await req.json().catch(() => ({})) as any
  const patch = {
    title: typeof body.title === 'string' ? body.title : undefined,
    brand: typeof body.brand === 'string' ? body.brand : undefined,
    model: typeof body.model === 'string' ? body.model : undefined,
    description: typeof body.description === 'string' ? body.description : undefined,
    beforeImages: Array.isArray(body.beforeImages) ? body.beforeImages.map(String) : undefined,
    afterImages: Array.isArray(body.afterImages) ? body.afterImages.map(String) : undefined,
    videos: Array.isArray(body.videos) ? body.videos.map(String) : undefined,
  }
  const updated = await updateCase(ctx.params.id, patch)
  if (!updated) return NextResponse.json({ error: 'Not found' }, { status: 404 })
  return NextResponse.json({ ok: true, case: updated })
}

export async function DELETE(req: Request, ctx: Ctx) {
  if (!requireAdminApi(req)) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  const ok = await deleteCase(ctx.params.id)
  if (!ok) return NextResponse.json({ error: 'Not found' }, { status: 404 })
  return NextResponse.json({ ok: true })
}
